const fs = require("fs-extra");
const axios = require("axios");

module.exports.config = {
  name: "antiProtect",
  version: "4.0.0",
  credits: "Chander Pahar x Gemini",
  description: "ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржПржмржВ ржЫржмрж┐ ржкрзНрж░ржЯрзЗржХрзНржЯ ржХрж░рж╛ + ржмрзЗржпрж╝рж╛ржжржм ржорзЗржорзНржмрж╛рж░ ржХрж┐ржХ ржжрзЗржУрзЯрж╛",
  eventType: ["log:thread-name", "log:thread-icon"],
  cooldowns: 3
};

module.exports.run = async function ({ api, event, Users }) {
  try {
    const { threadID, author } = event;
    const senderID = author || event.senderID;
    const botID = api.getCurrentUserID();
    const ownerID = "100056725134303"; // ржЖржкржирж╛рж░ ржЖржЗржбрж┐
    const sig = "\nтФДтФЙтЭИтЬбя╕ПтЛЖтГЭржЪрж╛ржБржжрзЗржбрж╝~ржкрж╛рж╣рж╛ржбрж╝тЬ┐тГЭЁЯкмтЭИтФЙтФД";

    const dir = `${__dirname}/../../cache/antiProtect/`;
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

    const dataFile = dir + `${threadID}.json`;

    const threadInfo = await api.getThreadInfo(threadID);
    const adminIDs = (threadInfo.adminIDs || []).map(i => i.id);
    const isAdmin = adminIDs.includes(senderID);
    const botAdmin = adminIDs.includes(botID);

    // ржмржЯ ржЕрзНржпрж╛ржбржорж┐ржи ржирж╛ рж╣рж▓рзЗ ржХрзЛржирзЛ ржХрж╛ржЬ ржХрж░ржмрзЗ ржирж╛
    if (!botAdmin) return;

    // ржбрж╛ржЯрж╛ ржлрж╛ржЗрж▓ ржирж╛ ржерж╛ржХрж▓рзЗ ржЧрзНрж░рзБржкрзЗрж░ ржмрж░рзНрждржорж╛ржи ржЕржмрж╕рзНржерж╛ рж╕рзЗржн ржХрж░ржмрзЗ
    if (!fs.existsSync(dataFile)) {
      const snap = {
        name: threadInfo.threadName || "",
        image: threadInfo.imageSrc || null
      };
      fs.writeFileSync(dataFile, JSON.stringify(snap, null, 2));
      return;
    }

    const old = JSON.parse(fs.readFileSync(dataFile));

    // ржпржжрж┐ ржЕрзНржпрж╛ржбржорж┐ржи ржмрж╛ ржмржЯ ржмрж╛ ржУржирж╛рж░ ржирж┐ржЬрзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ, рждржмрзЗ ржирждрзБржи рждржерзНржп рж╕рзЗржн рж╣ржмрзЗ
    if (isAdmin || senderID == botID || senderID == ownerID) {
      const snap = {
        name: threadInfo.threadName,
        image: threadInfo.imageSrc
      };
      fs.writeFileSync(dataFile, JSON.stringify(snap, null, 2));
      return;
    }

    // рж╕рж╛ржзрж╛рж░ржг ржорзЗржорзНржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж▓рзЗ ржПржЗ рж▓ржЬрж┐ржХ ржХрж╛ржЬ ржХрж░ржмрзЗ
    const name = await Users.getNameUser(senderID);

    switch (event.logMessageType) {

      case "log:thread-name": {
        await api.setTitle(old.name, threadID);
        // ржмрзЗрзЯрж╛ржжржм ржорзЗржорзНржмрж╛рж░ржХрзЗ ржХрж┐ржХ ржжрзЗржУрзЯрж╛рж░ рж▓ржЬрж┐ржХ
        await api.removeUserFromGroup(senderID, threadID);
        
        const msg = `тФПтФБтФБтФБтФБтФБтФБтФБ ЁЯЪл тФБтФБтФБтФБтФБтФБтФБтФУ\n   ЁЯФе ЁЭЧбЁЭЧФЁЭЧаЁЭЧШ ЁЭЧгЁЭЧеЁЭЧвЁЭЧзЁЭЧШЁЭЧЦЁЭЧзЁЭЧШЁЭЧЧ ЁЯФе\nтФЧтФБтФБтФБтФБтФБтФБтФБ ЁЯСЮ тФБтФБтФБтФБтФБтФБтФБтФЫ\n\nтЪая╕П ржХрж┐рж░рзЗ [ ${name} ]! \n\nрждрзЛрж░ ржПрждрзЛ ржмрзЬ рж╕рж╛рж╣рж╕ ржпрзЗ рждрзБржЗ ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржЪрзЗржЮрзНржЬ ржХрж░рж┐рж╕? ЁЯШВ рждрзБржЗ ржХрж┐ ржЬрж╛ржирж┐рж╕ ржирж╛ ржПржЗ ржЧрзНрж░рзБржкрзЗ 'ржЪрж╛ржБржжрзЗрж░ ржкрж╛рж╣рж╛рзЬ'-ржПрж░ ржкрзНрж░ржЯрзЗржХрж╢ржи ржжрзЗржУрзЯрж╛ ржЖржЫрзЗ? \n\nЁЯЪл ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржЖржмрж╛рж░ ржЖржЧрзЗрж░ ржорждрзЛ ржХрж░рзЗ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛред\nЁЯСЮ ржЖрж░ рждрзЛржХрзЗ ржПржЗ ржзрзГрж╖рзНржЯрждрж╛рж░ ржЬржирзНржп рж▓рж╛ржерж┐ ржорзЗрж░рзЗ ржЧрзНрж░рзБржк ржерзЗржХрзЗ ржмрзЗрж░ ржХрж░рзЗ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ! ржнрж╛ржЧ ржЖржмрж╛рж▓! ЁЯР╕${sig}`;
        
        api.sendMessage(msg, threadID);
        
        // ржУржирж╛рж░ржХрзЗ рж░рж┐ржкрзЛрж░рзНржЯ ржкрж╛ржарж╛ржирзЛ
        api.sendMessage(`ЁЯЪи ЁЭЧФЁЭЧ╗ЁЭШБЁЭЧ╢-ЁЭЧгЁЭЧ┐ЁЭЧ╝ЁЭШБЁЭЧ▓ЁЭЧ░ЁЭШБ ЁЭЧФЁЭЧ╣ЁЭЧ▓ЁЭЧ┐ЁЭШБ!\nтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\nЁЯП░ ржЧрзНрж░рзБржк: ${threadInfo.threadName}\nЁЯСд ржЗржЙржЬрж╛рж░: ${name}\nЁЯУЭ ржЕржкрж░рж╛ржз: ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржЪрзЗрж╖рзНржЯрж╛ред\nтЭМ ржЕрзНржпрж╛ржХрж╢ржи: ржХрж┐ржХ ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗред`, ownerID);
        break;
      }

      case "log:thread-icon": {
        try {
          if (old.image) {
            const res = await axios.get(old.image, { responseType: "arraybuffer" });
            const buf = Buffer.from(res.data, "binary");
            await api.changeGroupImage(fs.createReadStream(buf), threadID);
          }
        } catch {}

        // ржмрзЗрзЯрж╛ржжржм ржорзЗржорзНржмрж╛рж░ржХрзЗ ржХрж┐ржХ ржжрзЗржУрзЯрж╛рж░ рж▓ржЬрж┐ржХ
        await api.removeUserFromGroup(senderID, threadID);

        const msg = `тФПтФБтФБтФБтФБтФБтФБтФБ ЁЯЪл тФБтФБтФБтФБтФБтФБтФБтФУ\n   ЁЯУ╕ ЁЭЧЬЁЭЧЦЁЭЧвЁЭЧб ЁЭЧгЁЭЧеЁЭЧвЁЭЧзЁЭЧШЁЭЧЦЁЭЧзЁЭЧШЁЭЧЧ ЁЯУ╕\nтФЧтФБтФБтФБтФБтФБтФБтФБ ЁЯСЮ тФБтФБтФБтФБтФБтФБтФБтФЫ\n\nтЪая╕П ржХрж┐рж░рзЗ [ ${name} ]! \n\nрждрзЛрж░ ржорзБржЦ ржХрж┐ ржПрждрзЛржЗ рж╕рзБржирзНржжрж░ ржпрзЗ рждрзБржЗ ржЧрзНрж░рзБржкрзЗрж░ ржкрж┐ржХржЪрж╛рж░ ржкрж╛рж▓рзНржЯрж╛ржЗрждрзЗ ржЖрж╕ржЫрж╕? ЁЯШВ ржмрзЗрж╢рж┐ ржкрж╛ржХржирж╛ржорж┐ ржХрж░рж╛рж░ ржлрж▓ рж╣рж╛рждрзЗржирж╛рждрзЗ ржкрзЗрж▓рж┐ред \n\nтЬЕ ржЧрзНрж░рзБржкрзЗрж░ ржкрзБрж░рж╛ржирзЛ ржЫржмрж┐ ржЖржмрж╛рж░ рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред\nЁЯСЮ ржЖрж░ рждрзЛржХрзЗ ржЧрзНрж░рзБржк ржерзЗржХрзЗ ржирж░рзНржжржорж╛рзЯ рж▓рж╛ржерж┐ ржорж╛рж░рж╛ рж╣рж▓рзЛ! ржбрзНрж░рзЗржирзЗ ржЧрж┐рзЯрзЗ ржЧрзЛрж╕рж▓ ржХрж░ ржЧрзЗ ржпрж╛! ЁЯР╕${sig}`;

        api.sendMessage(msg, threadID);

        // ржУржирж╛рж░ржХрзЗ рж░рж┐ржкрзЛрж░рзНржЯ ржкрж╛ржарж╛ржирзЛ
        api.sendMessage(`ЁЯЪи ЁЭЧФЁЭЧ╗ЁЭШБЁЭЧ╢-ЁЭЧгЁЭЧ┐ЁЭЧ╝ЁЭШБЁЭЧ▓ЁЭЧ░ЁЭШБ ЁЭЧФЁЭЧ╣ЁЭЧ▓ЁЭЧ┐ЁЭШБ!\nтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\nЁЯП░ ржЧрзНрж░рзБржк: ${threadInfo.threadName}\nЁЯСд ржЗржЙржЬрж╛рж░: ${name}\nЁЯУЭ ржЕржкрж░рж╛ржз: ржЧрзНрж░рзБржкрзЗрж░ ржЫржмрж┐ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржЪрзЗрж╖рзНржЯрж╛ред\nтЭМ ржЕрзНржпрж╛ржХрж╢ржи: ржХрж┐ржХ ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗред`, ownerID);
        break;
      }
    }
  } catch (e) {
    console.log("antiProtect Error:", e);
  }
};
      
