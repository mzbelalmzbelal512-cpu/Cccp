const axios = require('axios');
const fs = require('fs-extra');
const path = require('path');

module.exports.config = {
  name: "ramadanphoto",
  version: "8.0.0",
  hasPermssion: 0,
  credits: "Belal x Gemini",
  description: "рж╕рзБржирзНржжрж░ рж░ржоржЬрж╛ржи ржЙржЗрж╢рж┐ржВ ржХрж╛рж░рзНржб рждрзИрж░рж┐ ржХрж░рзБржи (ржирзЛ рж╕рж╛рж░рзНржнрж╛рж░ ржмрж┐ржЬрж┐ ржЗрж╕рзНржпрзБ)",
  commandCategory: "graphics",
  usages: "[@ржорзЗржирж╢ржи / ржирж╛ржо]",
  cooldowns: 10
};

module.exports.run = async function ({ api, event, args }) {
  const { threadID, messageID, senderID, mentions } = event;

  try {
    let targetName;
    let targetID; // ржЖржЗржбрж┐ рж╢рзБржзрзБ ржорзЗрж╕рзЗржЬрзЗрж░ ржЬржирзНржп, ржЫржмрж┐рждрзЗ ржпрж╛ржмрзЗ ржирж╛

    // рзз. ржЯрж╛рж░рзНржЧрзЗржЯ ржирж╛ржо ржбрж┐ржЯрзЗржХрж╢ржи
    if (Object.keys(mentions).length > 0) {
      targetID = Object.keys(mentions)[0];
      targetName = mentions[targetID].replace('@', ''); // ржорзЗржирж╢ржи ржерзЗржХрзЗ ржирж╛ржо
    } else {
      targetID = senderID;
      const userInfo = await api.getUserInfo(targetID);
      targetName = args.join(" ") || userInfo[targetID].name; // ржирж┐ржЬрзЗрж░ ржирж╛ржо ржмрж╛ ржжрзЗржУрзЯрж╛ ржирж╛ржо
    }

    api.sendMessage(`тП│ ${targetName}-ржПрж░ ржЬржирзНржп ржЖржкржирж╛рж░ рж░рж╛ржЬржХрзАржпрж╝ рж░ржоржЬрж╛ржи рж╢рзБржнрзЗржЪрзНржЫрж╛ ржХрж╛рж░рзНржбржЯрж┐ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...`, threadID, messageID);

    // рзи. рж╕рзНржерж┐рждрж┐рж╢рзАрж▓ ржЯрзЗржХрзНрж╕ржЯ-ржЕржи-ржЗржорзЗржЬ ржПржкрж┐ржЖржЗ ржмрзНржпржмрж╣рж╛рж░ (ржХрзЛржирзЛ ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржкрж┐ржХржЪрж╛рж░ ржЖржкрж▓рзЛржб ржЫрж╛рзЬрж╛ржЗ)
    // ржПржЯрж┐ ржПржХржЯрж┐ ржирж┐рж░рзНржнрж░ржпрзЛржЧрзНржп ржЯрзЗржХрзНрж╕ржЯ ржПржбрж┐ржЯрж░ ржПржкрж┐ржЖржЗ ржпрж╛ ржПржХржЯрж┐ ржкрзНрж░рж┐-ржбрж┐ржЬрж╛ржЗржиржб ржЯрзЗржоржкрзНрж▓рзЗржЯрзЗ ржирж╛ржо ржмрж╕рж╛рзЯред
    const imageUrl = `https://api.popcat.xyz/ramadan?text=${encodeURIComponent(targetName)}`;
    
    // ржмрж┐ржХрж▓рзНржк ржПржкрж┐ржЖржЗ (ржпржжрж┐ Popcat ржбрж╛ржЙржи ржерж╛ржХрзЗ) - ржПржЯрж╛ ржЯрзЗржХрзНрж╕ржЯржкрзНрж░рзЛ рж╕рзНржЯрж╛ржЗрж▓
    const backupUrl = `https://textpro.me/generate-luxury-gold-text-effect-online-free-1049.html?text=${encodeURIComponent(targetName)}`; // ржПржЗ ржПржкрж┐ржЖржЗ рж╕рж░рж╛рж╕рж░рж┐ ржЗржорзЗржЬ ржжрзЗрзЯ ржирж╛, рждрж╛ржЗ ржПржХржЯрзБ ржЯрзНрж░рж┐ржХ рж▓рж╛ржЧржмрзЗред
    // ржпрзЗрж╣рзЗрждрзБ TextPro рж╕рж░рж╛рж╕рж░рж┐ ржЗржорзЗржЬ ржЗржЙржЖрж░ржПрж▓ ржжрзЗрзЯ ржирж╛, ржЖржорж┐ ржПржЦрж╛ржирзЗ ржПржХржЯрж┐ ржЬрзЗржирзЗрж░рж┐ржХ ржлрж┐ржХрзНрж╕ржб рж░ржоржЬрж╛ржи ржХрж╛рж░рзНржбрзЗрж░ URL ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐ред
    const genericRamadanCardUrl = "https://i.imgur.com/KndNQ0w.jpeg"; // ржПржХржЯрж┐ ржХржоржи рж░ржоржЬрж╛ржи ржХрж╛рж░рзНржб

    const imagePath = path.join(__dirname, 'cache', `ramadan_card_${senderID}.png`);
    
    let response;
    try {
        response = await axios.get(imageUrl, { responseType: 'arraybuffer' });
        fs.writeFileSync(imagePath, Buffer.from(response.data, 'utf-8'));
    } catch (e) {
        // ржпржжрж┐ Popcat ржХрж╛ржЬ ржирж╛ ржХрж░рзЗ, рждржмрзЗ ржПржХржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржХрж╛рж░рзНржбрзЗ ржирж╛ржо рж▓рж┐ржЦрзЗ ржкрж╛ржарж╛ржирзЛрж░ ржЪрзЗрж╖рзНржЯрж╛
        // ржПржЯрж┐ ржПржХржЯрзБ ржЬржЯрж┐рж▓, рждрж╛ржЗ рж╕рж╣ржЬржнрж╛ржмрзЗ ржПржХржЯрж┐ ржЯрзЗржХрзНрж╕ржЯ ржорзЗрж╕рзЗржЬ рж╕рж╣ ржбрж┐ржлрж▓рзНржЯ ржЗржорзЗржЬ ржкрж╛ржарж╛ржмрзЛ
        api.sendMessage(`тЪая╕П ржЗржорзЗржЬ ржЬрзЗржирж╛рж░рзЗржЯрж░ рж╕рж╛рж░рзНржнрж╛рж░ ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржмрж┐ржЬрж┐ред ${targetName}-ржПрж░ ржЬржирзНржп ржПржХржЯрж┐ ржЯрзЗржХрзНрж╕ржЯ-ржХрж╛рж░рзНржб рждрзИрж░рж┐ ржХрж░ржЫрж┐...`, threadID, messageID);
        return api.sendMessage(`ЁЯМЩ тЬи **${targetName}** ржХрзЗ ржЬрж╛ржирж╛ржЗ **RAMADAN MUBARAK**! тЬи ЁЯМЩ\n\nржЖрж▓рзНрж▓рж╛рж╣ ржЖржкржирж╛рж░ рж░рзЛржЬрж╛ ржХржмрзБрж▓ ржХрж░рзБржиред\n\nтЬбя╕ПтГЭЁЯЕ░ЁЯЕ│ЁЯЕ╝ЁЯЕ╕ЁЯЗ│тФА═в═вржЪрзГрж╛ржБржжрзЗрзГржБрж░рзГржБ ржкрж╛рзГржБрж╣рж╛рзНржБрзЬрзГржБтЬбя╕П`, threadID, messageID);
    }

    // рзй. ржлрж╛ржЗржирж╛рж▓ ржорзЗрж╕рзЗржЬ ржЙржЗрже ржбрж┐ржЯрзЗржЗрж▓рж╕
    const msg = `ЁЯМЩ **RAMADAN MUBARAK** ${targetName}!\n\nтЬи ржЖржкржирж╛рж░ рж░ржоржЬрж╛ржи ржЖржиржирзНржжржорзЯ рж╣рзЛржХред\n\nтЬбя╕ПтГЭЁЯЕ░ЁЯЕ│ЁЯЕ╝ЁЯЕ╕ЁЯЗ│тФА═в═вржЪрзГрж╛ржБржжрзЗрзГржБрж░рзГржБ ржкрж╛рзГржБрж╣рж╛рзНржБрзЬрзГржБтЬбя╕П`;

    return api.sendMessage({
      body: msg,
      attachment: fs.createReadStream(imagePath)
    }, threadID, () => fs.unlinkSync(imagePath), messageID);

  } catch (err) {
    console.error(err);
    // ржЪрзВржбрж╝рж╛ржирзНржд ржлрж▓ржмрзНржпрж╛ржХ: ржпржжрж┐ ржХрж┐ржЫрзБржЗ ржХрж╛ржЬ ржирж╛ ржХрж░рзЗ
    return api.sendMessage(`тЭМ ржмрзЗрж▓рж╛рж▓ ржнрж╛ржЗ, ржжрзБржГржЦрж┐ржд! ржХрзЛржирзЛ ржЗржорзЗржЬ ржХрж╛рж░рзНржб рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ред\n\nЁЯМЩ ${targetName}-ржХрзЗ ржЬрж╛ржирж╛ржЗ рж░ржоржЬрж╛ржи ржорзБржмрж╛рж░ржХ!\n\nтЬбя╕ПтГЭЁЯЕ░ЁЯЕ│ЁЯЕ╝ЁЯЕ╕ЁЯЗ│тФА═в═вржЪрзГрж╛ржБржжрзЗрзГржБрж░рзГржБ ржкрж╛рзГржБрж╣рж╛рзНржБрзЬрзГржБтЬбя╕П`, threadID, messageID);
  }
};
